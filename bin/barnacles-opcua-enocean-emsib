#!/usr/bin/env node

const opcua = require('node-opcua');
const BarnaclesOPCUA = require('../lib/barnaclesopcua.js');

const INITIAL_HOLDOFF_MILLISECONDS = 5000;
const UPDATE_PERIOD_MILLISECONDS = 60000;


let txCount = 0;


let barnaclesOPCUA = new BarnaclesOPCUA({ printErrors: true });
setTimeout(generateSensorData, INITIAL_HOLDOFF_MILLISECONDS);


function generateSensorData() {
  let dynamb = {
    deviceId: "e500100e851b",
    deviceIdType: 3,
    acceleration: Array.from({ length: 3 }, () => Math.random() + 0.5),
    batteryPercentage: Math.round(Math.random() * 100),
    illuminance: Math.round(Math.random() * 300),
    isContactDetected: [ (Math.random() > 0.5) ],
    isMotionDetected: [ (Math.random() > 0.5) ],
    relativeHumidity: 30 + Math.round(Math.random() * 40),
    temperature: 21 + (Math.random() * 10),
    timestamp: Date.now(),
    txCount: ++txCount
  };

  barnaclesOPCUA.handleEvent('dynamb', dynamb);
  setTimeout(generateSensorData, UPDATE_PERIOD_MILLISECONDS);
}


console.log('barnacles-opcua EnOcean EMSIB sensor simulator');
